# Artemis Next Generation

aka ArtemisNG has been designed to run tests using docker-compose, in order to be easily deployed.

## How to use

### 1. Run Navitia services in docker containers

*   You can clone the repository navitia-docker-compose, available [here](https://github.com/CanalTP/navitia-docker-compose) and follow the instructions in the [readme](https://github.com/CanalTP/navitia-docker-compose/blob/master/README.md) file to have the whole Navitia environment running.
    - Basic usage: launch this command at the root directory of the repo 'navitia-docker-compose':\
    `docker-compose -f docker-compose.yml -f artemis/docker-artemis-instance.yml up`

        *Note: the file in the command above [docker-artemis-instance.yml](https://github.com/CanalTP/navitia-docker-compose/blob/master/artemis/docker-artemis-instance.yml) references every coverages available for Artemis. Therefore, a docker container will be started for each of these coverages. You can edit this file to start only the coverage(s) needed.*
    - To run real-time tests, Kirin is needed. Please refer to these
    [instructions](https://github.com/CanalTP/navitia-docker-compose/blob/master/kirin/README.md) to have it in the docker-compose. In this case, the command is:\
    `docker-compose -f docker-compose.yml -f artemis/docker-artemis-instance.yml -f kirin/docker-compose_kirin.yml up`

    - To stop the running containers and remove them along with the associated networks and volumes, use the same command to start the containers and replace `up` with `down -v`
### 2. Run tests with Artemis NG

Once all containers are running, it's time to run the tests.

* Create a virtual environment with the python packages in requirements.txt (for python 3):\
    `mkvirtualenv  -p python3 -r requirements.txt <venv_name>`

* In default_settings.py, set the following parameters:
    - USE_ARTEMIS_NG = True
    - URL_JORMUN (with port)
    - URL_TYR
    - DATA_DIR (artemis data)
    - REFERENCE_FILE_PATH (the path to artemis references)
    - RESPONSE_FILE_PATH (Optional, output of the responses generated by artemis)
    - KIRIN_API (if needed)
    - KIRIN_DB (if needed)
      If Kirin is launched via kirin/docker-compose_kirin.yml, use the parameters from the section 'kirin_database' from the file [docker-compose-kirin](https://github.com/CanalTP/navitia-docker-compose/blob/master/kirin/docker-compose_kirin.yml):\
      By default: `KIRIN_DB = 'dbname=kirin user=navitia password=navitia host=localhost port=9494'`

* Launch tests: `py.test artemis/tests`
    - As for the old Artemis, it's possible to create a custom config file with the values above and call `CONFIG_FILE=my_settings.py py.test artemis/tests`
    - If you don't want to call `cities`, add `--skip_cities`
    - If the data has already been binarized, add `--skip_bina`
    - If you want to show prints, you can also add this argument `-s`
    - If you are adding a new test, you can use `--create_ref` to create a reference file for your test in REFERENCE_FILE_PATH.
      Works only if there is no reference file for your test.
      If a reference file for a test already exists, the test will fail and no reference will be created.
    - Of course, every pytest invocation arguments can also be used on this command.\
      *Ex: if you want to run a specific test (or a tests class for a coverage)*`-k <tests_to_run>`

### Or... Docker orchestrator

See [here](https://github.com/CanalTP/artemis/blob/master/artemis/docker_orchestrator.md) how the orchestrator can handle the 2 steps above.


## Contributing

Old or New, pre-commits are always nice to have.Please refer to this [section](https://github.com/CanalTP/artemis#contributing) for more info.
